# Cookie-based State Management with Cross-Tab Synchronization

–¶–µ–π –ø—Ä–æ–µ–∫—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î cookies –∑–∞–º—ñ—Å—Ç—å localStorage –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –∫–æ—Ä–∑–∏–Ω–∏, —â–æ –∑–∞–±–µ–∑–ø–µ—á—É—î –∫—Ä–∞—â—É –ø—ñ–¥—Ç—Ä–∏–º–∫—É SSR —Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é –º—ñ–∂ —Å–µ—Ä–≤–µ—Ä–æ–º —Ç–∞ –∫–ª—ñ—î–Ω—Ç–æ–º. **–ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∫–æ—Ä–∑–∏–Ω–∏ –º—ñ–∂ —Ä—ñ–∑–Ω–∏–º–∏ –≤–∫–ª–∞–¥–∫–∞–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—ñ–≤

```
lib/
‚îú‚îÄ‚îÄ store.ts                    # Zustand store –∑ cookie persistence —Ç–∞ cross-tab sync
‚îú‚îÄ‚îÄ cookies.ts                  # –£—Ç–∏–ª—ñ—Ç–∏ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ cookies
‚îú‚îÄ‚îÄ server-cookies.ts           # –°–µ—Ä–≤–µ—Ä–Ω—ñ —Ö—É–∫–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ cookies
‚îú‚îÄ‚îÄ sync-test-utils.ts          # –£—Ç–∏–ª—ñ—Ç–∏ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
‚îî‚îÄ‚îÄ README.md                   # –¶—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

components/
‚îú‚îÄ‚îÄ sync-indicator.tsx          # –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
‚îî‚îÄ‚îÄ sync-debugger.tsx           # Debug –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (—Ç—ñ–ª—å–∫–∏ –¥–ª—è —Ä–æ–∑—Ä–æ–±–∫–∏)

hooks/
‚îî‚îÄ‚îÄ use-cross-tab-sync.ts       # –•—É–∫ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ cross-tab sync
```

## üîß –û—Å–Ω–æ–≤–Ω—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

### 1. `store.ts` - Zustand Store –∑ Cross-Tab Sync

- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `createJSONStorage` –¥–ª—è cookie persistence
- **–ù–æ–≤–æ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –º—ñ–∂ –≤–∫–ª–∞–¥–∫–∞–º–∏
- –ü—ñ–¥—Ç—Ä–∏–º—É—î `BroadcastChannel` API —Ç–∞ fallback –Ω–∞ storage events
- –í–∫–ª—é—á–∞—î —Å—Ç–∞–Ω `isSyncing` –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó

### 2. `cookies.ts` - Cookie –£—Ç–∏–ª—ñ—Ç–∏

- `getCookie(name)` - –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–Ω–∞—á–µ–Ω–Ω—è cookie
- `setCookie(name, value, days)` - –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è cookie
- `deleteCookie(name)` - –≤–∏–¥–∞–ª–µ–Ω–Ω—è cookie
- `parseCookies(header)` - –ø–∞—Ä—Å–∏–Ω–≥ cookie header –¥–ª—è SSR

### 3. `server-cookies.ts` - –°–µ—Ä–≤–µ—Ä–Ω—ñ —Ö—É–∫–∏

- `getServerCart()` - –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫–æ—Ä–∑–∏–Ω–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
- `getServerCartItemCount()` - –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤ –≤ –∫–æ—Ä–∑–∏–Ω—ñ
- `getServerCartTotalPrice()` - –∑–∞–≥–∞–ª—å–Ω–∞ –≤–∞—Ä—Ç—ñ—Å—Ç—å –∫–æ—Ä–∑–∏–Ω–∏

### 4. **–ù–æ–≤–æ**: Cross-Tab Synchronization

- `sync-indicator.tsx` - –ø–æ–∫–∞–∑—É—î —Å—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
- `sync-debugger.tsx` - debug —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –¥–ª—è —Ä–æ–∑—Ä–æ–±–∫–∏
- `use-cross-tab-sync.ts` - —Ö—É–∫ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—î—é

## üöÄ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### –ö–ª—ñ—î–Ω—Ç—Å—å–∫–∞ —Å—Ç–æ—Ä–æ–Ω–∞:

```typescript
import { useCartStore } from "@/lib/store";

const { addToCart, items, isSyncing } = useCartStore();
```

### –°–µ—Ä–≤–µ—Ä–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–∞:

```typescript
import { getServerCartItemCount } from "@/lib/server-cookies";

export default function Layout() {
  const cartItemCount = getServerCartItemCount();
  // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ cartItemCount –¥–ª—è SSR
}
```

### Cross-Tab Sync:

```typescript
import { useCrossTabSync } from "@/hooks/use-cross-tab-sync";

const { tabId, syncCount, isSyncing, testSync } = useCrossTabSync();
```

## üîÑ Cross-Tab Synchronization

### –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:

1. **BroadcastChannel API** (—Å—É—á–∞—Å–Ω—ñ –±—Ä–∞—É–∑–µ—Ä–∏):
   - –°—Ç–≤–æ—Ä—é—î –∫–∞–Ω–∞–ª `cart-sync` –¥–ª—è –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó –º—ñ–∂ –≤–∫–ª–∞–¥–∫–∞–º–∏
   - –í—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–∏ –∫–æ–∂–Ω—ñ–π –∑–º—ñ–Ω—ñ –∫–æ—Ä–∑–∏–Ω–∏
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î —Å—Ç–∞–Ω –≤ —ñ–Ω—à–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö

2. **Storage Events** (fallback –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –±—Ä–∞—É–∑–µ—Ä—ñ–≤):
   - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `storage` event –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–ø—Ä–∞—Ü—å–æ–≤—É—î –ø—Ä–∏ –∑–º—ñ–Ω—ñ cookies
   - –ó–∞–±–µ–∑–ø–µ—á—É—î —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å –∑ —É—Å—ñ–º–∞ –±—Ä–∞—É–∑–µ—Ä–∞–º–∏

3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è**:
   - –ü—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ/–≤–∏–¥–∞–ª–µ–Ω–Ω—ñ —Ç–æ–≤–∞—Ä—É
   - –ü—Ä–∏ –∑–º—ñ–Ω—ñ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
   - –ü—Ä–∏ –æ—á–∏—â–µ–Ω–Ω—ñ –∫–æ—Ä–∑–∏–Ω–∏

### –ü–µ—Ä–µ–≤–∞–≥–∏:

‚úÖ **–ú–∏—Ç—Ç—î–≤–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è** –º—ñ–∂ –≤–∫–ª–∞–¥–∫–∞–º–∏  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è** –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è  
‚úÖ **Fallback –º–µ—Ö–∞–Ω—ñ–∑–º–∏** –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö –±—Ä–∞—É–∑–µ—Ä—ñ–≤  
‚úÖ **–í—ñ–∑—É–∞–ª—å–Ω—ñ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏** —Å—Ç–∞—Ç—É—Å—É —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó  
‚úÖ **Debug —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏** –¥–ª—è —Ä–æ–∑—Ä–æ–±–∫–∏

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó

### 1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ –∫—ñ–ª—å–∫–∞ –≤–∫–ª–∞–¥–æ–∫ –∑ –≤–∞—à–∏–º —Å–∞–π—Ç–æ–º

### 2. –î–æ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É –≤ –æ–¥–Ω—ñ–π –≤–∫–ª–∞–¥—Ü—ñ

### 3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ –∫–æ—Ä–∑–∏–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–∏–ª–∞—Å—è –≤ —ñ–Ω—à–∏—Ö –≤–∫–ª–∞–¥–∫–∞—Ö

### 4. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ debug –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É

### Debug –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–æ–∫–∞–∑—É—î:

- –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID –≤–∫–ª–∞–¥–∫–∏
- –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ–π
- –ß–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ—ó —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
- –ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å
- –¢–µ—Å—Ç–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó

## ‚úÖ –ü–µ—Ä–µ–≤–∞–≥–∏ cookies –Ω–∞–¥ localStorage

1. **SSR –ø—ñ–¥—Ç—Ä–∏–º–∫–∞** - –¥–∞–Ω—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
2. **–ö—Ä–∞—â–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è** - –º—ñ–∂ —Å–µ—Ä–≤–µ—Ä–æ–º —Ç–∞ –∫–ª—ñ—î–Ω—Ç–æ–º
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è** - –∑ –∫–æ–∂–Ω–∏–º HTTP –∑–∞–ø–∏—Ç–æ–º
4. **–ë–µ–∑–ø–µ–∫–∞** - –º–æ–∂–Ω–∞ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ httpOnly, secure —Ñ–ª–∞–≥–∏
5. **Cross-tab sync** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –º—ñ–∂ –≤–∫–ª–∞–¥–∫–∞–º–∏

## ‚ö†Ô∏è –û–±–º–µ–∂–µ–Ω–Ω—è

1. **–†–æ–∑–º—ñ—Ä** - cookies –º–∞—é—Ç—å –æ–±–º–µ–∂–µ–Ω–Ω—è 4KB
2. **–ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è** - cookies –Ω–∞–¥—Å–∏–ª–∞—é—Ç—å—Å—è –∑ –∫–æ–∂–Ω–∏–º –∑–∞–ø–∏—Ç–æ–º
3. **–ë—Ä–∞—É–∑–µ—Ä–Ω—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è** - –¥–µ—è–∫—ñ –±—Ä–∞—É–∑–µ—Ä–∏ –º–æ–∂—É—Ç—å –±–ª–æ–∫—É–≤–∞—Ç–∏ cookies
4. **–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è** - –º–æ–∂–µ –±—É—Ç–∏ –∑–∞—Ç—Ä–∏–º–∫–∞ –≤ 100-200ms –º—ñ–∂ –≤–∫–ª–∞–¥–∫–∞–º–∏

## üîí –ë–µ–∑–ø–µ–∫–∞

- Cookies –º–∞—é—Ç—å `SameSite=Lax` –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ CSRF
- –¢–µ—Ä–º—ñ–Ω –¥—ñ—ó –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ 30 –¥–Ω—ñ–≤
- –î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ
- Cross-tab sync –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –±–µ–∑–ø–µ—á–Ω—ñ –∫–∞–Ω–∞–ª–∏ –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó

## üì± –ì—ñ–¥—Ä–∞—Ç–∞—Ü—ñ—è

–î–ª—è —É–Ω–∏–∫–Ω–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º –∑ –≥—ñ–¥—Ä–∞—Ç–∞—Ü—ñ—î—é –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `mounted` —Å—Ç–∞–Ω:

```typescript
const [mounted, setMounted] = useState(false)

useEffect(() => {
  setMounted(true)
}, [])

// –ü–æ–∫–∞–∑—É–π—Ç–µ UI —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è –º–æ–Ω—Ç—É–≤–∞–Ω–Ω—è
{mounted && <CartIndicator count={itemCount} />}
```

## üöÄ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

1. **–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó** - –≤—ñ–¥–∫—Ä–∏–π—Ç–µ –∫—ñ–ª—å–∫–∞ –≤–∫–ª–∞–¥–æ–∫
2. **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ** - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ debug –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
3. **–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è** - –Ω–∞–ª–∞—à—Ç—É–π—Ç–µ –∑–∞—Ç—Ä–∏–º–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
4. **–†–æ–∑—à–∏—Ä–µ–Ω–Ω—è** - –¥–æ–¥–∞–π—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é –¥–ª—è —ñ–Ω—à–∏—Ö –¥–∞–Ω–∏—Ö
